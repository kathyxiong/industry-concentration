<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Industry Employment Visualization</title>
        <script type="text/javascript" src="d3/d3.js"></script>
    </head>
    <body>
        <script>

        var margin = {top: 100, right: 20, bottom: 20, left: 250},
            width = 1200 - margin.right - margin.left,
            height = 800 - margin.top - margin.bottom;

        var formatPercent = d3.format(".0%");

        var x = d3.scaleLinear()
            .range([0, width]);

        var y = d3.scaleBand()
            .rangeRound([0, height])
            .padding(0.1);

        var col = d3.scaleOrdinal()
            .range(["#e41a1c",
                    "#377eb8",
                    "#4daf4a",
                    "#984ea3"]);

        var xAxis = d3.axisTop()
            .scale(x)
            .tickFormat(formatPercent);

        var yAxis = d3.axisLeft()
            .scale(y);

        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", width + margin.right + margin.left)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var rowConverter = function(d) {
            return {
                area_fips: d.area_fips,
                area_title: d.area_title,
                industry_code: d.industry_code,
                industry_title: d.industry_title,
                local_pct_annual_avg_emplvl: +d.local_pct_annual_avg_emplvl,
                local_pct_total_annual_wages: +d.local_pct_total_annual_wages,
                us_pct_annual_avg_emplvl: +d.us_pct_annual_avg_emplvl,
                us_pct_total_annual_wages: +d.us_pct_total_annual_wages,
                region: d.region
            };
        }

        d3.csv("/data_cleaned/viz_data.csv", rowConverter).then(function(data) {

            var sort_y = function(a, b) { 
                return d3.descending(a.us_pct_annual_avg_emplvl, b.us_pct_annual_avg_emplvl); 
            }

            x.domain([0, d3.max(data, function(d) { return d.local_pct_annual_avg_emplvl; })]);
            y.domain(data.sort(sort_y).map(function(d) { return d.industry_title; }));

            svg.append("g")
                .attr("class", "x axis")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
            
            // draw bars

            // first draw static grey bars in the background
            svg.selectAll(".bar-background")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar-background")
                .attr("x", function(d) { return x(d.local_pct_annual_avg_emplvl) - 2; })
                .attr("y", function(d) { return y(d.industry_title); })
                .attr("height", y.bandwidth())
                .attr("width", 4)
                .attr("fill", "#d3d3d3");

            // then draw bars colored by region that can be toggled on/off
            svg.selectAll(".bar-foreground")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar-foreground")
                .attr("x", function(d) { return x(d.local_pct_annual_avg_emplvl) - 2; })
                .attr("y", function(d) { return y(d.industry_title); })
                .attr("height", y.bandwidth())
                .attr("width", 4)
                .attr("fill", function(d) { return col(d.region); })
                .attr("visibility", "visible");

            // draw buttons for each region
            var regionButton = [{region: "All Regions", class: "region-all"},
                                {region: "West",        class: "region-west"},
                                {region: "Midwest",     class: "region-midwest"},
                                {region: "South",       class: "region-south"},
                                {region: "Northeast",   class: "region-northeast"}];            

            // first draw the "off" buttons
            var regionOff = svg.selectAll(".region-off")
                .data(regionButton)
                .enter()
                .append("g")
                .attr("class", function(d) { return "region-off " + d.class; });

            regionOff.append("rect")
                //.attr("class", function(d) { return "region-off " + d.class; })
                .attr("x", function(d, i) { return i * 80; })
                .attr("y", -60)
                .attr("width", 70)
                .attr("height", 30)
                .attr("stroke-width", 2)
                .attr("stroke", function(d) { 
                    if(d.region == "All Regions") {
                        return "black";
                    } else {
                        return col(d.region); 
                    }
                })
                .attr("fill", "white");

            regionOff.append("text")
                .attr("x", function(d, i) { return i * 80; })
                .attr("y", -60)
                .attr("dx", 35)
                .attr("dy", 18)
                //.attr("width", 70)
                //.attr("height", 30)
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "12px")
                .attr("fill", function(d) { 
                    if(d.region == "All Regions") {
                        return "black";
                    } else {
                        return col(d.region); 
                    }
                })
                .text(function(d) { return d.region; });

            // then draw the "on" buttons
            var regionOn = svg.selectAll(".region-on")
                .data(regionButton)
                .enter()
                .append("g")
                .attr("class", function(d) { return "region-on " + d.class; })
                .attr("visibility", "hidden");

            regionOn.append("rect")
                //.attr("class", function(d) { return "region-on " + d.class; })
                .attr("x", function(d, i) { return i * 80; })
                .attr("y", -60)
                .attr("width", 70)
                .attr("height", 30)
                .attr("stroke-width", 2)
                .attr("stroke", function(d) { 
                    if(d.region == "All Regions") {
                        return "black";
                    } else {
                        return col(d.region); 
                    }
                })
                .attr("fill", function(d) { 
                    if(d.region == "All Regions") {
                        return "black";
                    } else {
                        return col(d.region); 
                    }
                });
                //.attr("visibility", "hidden");

            regionOn.append("text")
                .attr("x", function(d, i) { return i * 80; })
                .attr("y", -60)
                .attr("dx", 35)
                .attr("dy", 18)
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "12px")
                .attr("fill", "white")
                .text(function(d) { return d.region; });

            // create toggle action
            svg.select(".region-west.region-off")
                .on("click", function() {

                    // turn all "on" buttons "off"..
                    svg.selectAll(".region-on")
                        .attr("visibility", "hidden");

                    // ..except the region you are clicking on
                    svg.select(".region-west.region-on")
                        .attr("visibility", "visible");

                    // do the same for the bars
                    svg.selectAll(".bar-foreground")
                        .attr("visibility", "hidden");

                    svg.selectAll(".bar-foreground")
                        .data(data)
                        .filter(function(d) {
                            return d.region == "West";
                        })
                        .attr("visibility", "visible");
                });

            svg.select(".region-midwest.region-off")
                .on("click", function() {
                    svg.selectAll(".region-on")
                        .attr("visibility", "hidden");

                    svg.select(".region-midwest.region-on")
                        .attr("visibility", "visible");

                    svg.selectAll(".bar-foreground")
                        .attr("visibility", "hidden");

                    svg.selectAll(".bar-foreground")
                        .data(data)
                        .filter(function(d) {
                            return d.region == "Midwest";
                        })
                        .attr("visibility", "visible");
                });

            svg.select(".region-south.region-off")
                .on("click", function() {
                    svg.selectAll(".region-on")
                        .attr("visibility", "hidden");
                    svg.select(".region-south.region-on")
                        .attr("visibility", "visible");

                    svg.selectAll(".bar-foreground")
                        .attr("visibility", "hidden");

                    svg.selectAll(".bar-foreground")
                        .data(data)
                        .filter(function(d) {
                            return d.region == "South";
                        })
                        .attr("visibility", "visible");
                });

            svg.select(".region-northeast.region-off")
                .on("click", function() {
                    svg.selectAll(".region-on")
                        .attr("visibility", "hidden");
                    svg.select(".region-northeast.region-on")
                        .attr("visibility", "visible");

                    svg.selectAll(".bar-foreground")
                        .attr("visibility", "hidden");

                    svg.selectAll(".bar-foreground")
                        .data(data)
                        .filter(function(d) {
                            return d.region == "Northeast";
                        })
                        .attr("visibility", "visible");
                });

            svg.select(".region-all.region-off")
                .on("click", function() {
                    svg.selectAll(".region-on")
                        .attr("visibility", "hidden");
                    svg.select(".region-all.region-on")
                        .attr("visibility", "visible");

                    // turn all regions on
                    svg.selectAll(".bar-foreground")
                        .attr("visibility", "visible");
                });

            // // create toggle action
            // svg.select(".region-west.region-off")
                
            //     .on("click", function() {

            //         // turn off all "on" buttons ..
            //         svg.select(".region-on")
            //             .attr("visibility", "hidden");

            //         // .. except the region you are clicking
            //         svg.select(".region-west.region-on")
            //             .attr("visibility", "visible");

            //     });

            // svg.select(".region-midwest.region-off")
                
            //     .on("click", function() {

            //         svg.select(".region-on")
            //             .attr("visibility", "hidden");

            //         svg.select(".region-midwest.region-on")
            //             .attr("visibility", "visible");
                        
            //     });

            

            

            // bind toggle interaction to button
            // svg.select(".region-midwest").on("click", function() { toggleRegion(d3.select(this), "Midwest")} );
            // svg.select(".region-west").on("click", function() { toggleRegion(d3.select(this), "West")} );
            // svg.select(".region-northeast").on("click", function() { toggleRegion(d3.select(this), "Northeast")} );
            // svg.select(".region-south").on("click", function() { toggleRegion(d3.select(this), "South")} );

        });

        </script>
    </body>
</html>
